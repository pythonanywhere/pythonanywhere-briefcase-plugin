name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  test:
    uses: ./.github/workflows/test.yml

  build_package:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Install uv
      uses: astral-sh/setup-uv@6b9c6063abd6010835644d4c2e1bef4cf5cd0fca # v6.0.1

    - name: Set up Python
      run: uv python install 3.13

    - name: Check tag matches version files
      run: |
        TAG_VERSION="${GITHUB_REF##*/}"
        TAG_VERSION_NO_PREFIX="${TAG_VERSION#v}"
        echo "Tag version: $TAG_VERSION (stripped: $TAG_VERSION_NO_PREFIX)"

        PYPROJECT_VERSION=$(grep '^version =' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
        echo "pyproject.toml version: $PYPROJECT_VERSION"

        INIT_VERSION=$(grep '^__version__ =' src/pythonanywhere_briefcase_plugin/__init__.py | sed 's/__version__ = "\(.*\)"/\1/')
        echo "__init__.py version: $INIT_VERSION"

        if [ "$TAG_VERSION_NO_PREFIX" != "$PYPROJECT_VERSION" ]; then
          echo "Tag version ($TAG_VERSION_NO_PREFIX) does not match pyproject.toml version ($PYPROJECT_VERSION)" >&2
          exit 1
        fi

        if [ "$TAG_VERSION_NO_PREFIX" != "$INIT_VERSION" ]; then
          echo "Tag version ($TAG_VERSION_NO_PREFIX) does not match __init__.py version ($INIT_VERSION)" >&2
          exit 1
        fi

        if [ "$PYPROJECT_VERSION" != "$INIT_VERSION" ]; then
          echo "pyproject.toml version ($PYPROJECT_VERSION) does not match __init__.py version ($INIT_VERSION)" >&2
          exit 1
        fi
      shell: bash

    - name: Build package
      run: uv build

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: dist
        path: dist/

  create_release:
    runs-on: ubuntu-latest
    needs: build_package
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: dist
        path: dist/

    - name: Create Release
      uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
      with:
        files: |
          dist/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy_docs:
    runs-on: ubuntu-latest
    needs: build_package
    steps:
    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Install uv
      uses: astral-sh/setup-uv@6b9c6063abd6010835644d4c2e1bef4cf5cd0fca # v6.0.1

    - name: Set up Python
      run: uv python install 3.13

    - name: Build documentation
      run: uvx --with mkdocs-material mkdocs build

    - name: Setup SSH key
      uses: webfactory/ssh-agent@a6f90b1f127823b31d4d4a8d96047790581349bd # v0.9.1
      with:
        ssh-private-key: ${{ secrets.DOCS_DEPLOY_SSH_KEY }}

    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ssh.pythonanywhere.com >> ~/.ssh/known_hosts

    - name: Deploy to PythonAnywhere
      run: |
        rsync -av --delete site/ briefcase@ssh.pythonanywhere.com:/home/briefcase/docs/
